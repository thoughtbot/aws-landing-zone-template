---
AWSTemplateFormatVersion: '2010-09-09'
Description: Provide foundational resources for GitHub self-hosted runners

Parameters:
  Repository:
    Description: Name of the GitHub repository allowed to access secrets
    Type: String
  RoleName:
    Description: Name of the IAM role GitHub actions are allowed to assume
    Type: String
    Default: github-actions

Resources:
  # IAM OIDCProvider which allows GitHub Actions to assume federated identities
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      ClientIdList:
      - sts.amazonaws.com
      ThumbprintList:
      - 6938fd4d98bab03faadb97b34396831e3780aea1
      Url: https://token.actions.githubusercontent.com

  # Allow the delegation role to assume other roles tagged with the source repo
  DelegationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref RoleName
      Description: IAM role assumed by GitHub actions for Terraform
      Policies:
      - PolicyName: AllowTaggedRoles
        PolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: sts:AssumeRole
              Resource: "*"
              Condition:
                StringEquals:
                  aws:ResourceTag/Repository: !Ref Repository
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowGitHubRunners
            Effect: Allow
            Action:
            - sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !Ref GitHubOIDCProvider
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub "repo:${Repository}:*"

  # KMS key for self-hosted runner secrets
  KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: GitHub self-hosted runners
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Id: privatekey
        Statement:
        - Sid: DelegateKeyManagement
          Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
          NotAction:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          Resource: '*'
        - Sid: AllowSecretsManager
          Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          Resource: '*'
          Condition:
            StringEquals:
              "kms:ViaService":
              - !Sub "secretsmanager.${AWS::Region}.amazonaws.com"
        - Sid: AllowParameterStore
          Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          Resource: '*'
          Condition:
            StringLike:
              "kms:EncryptionContext:PARAMETER_ARN":
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*"
  KMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}"
      TargetKeyId: !GetAtt KMSKey.Arn

  # Create SSM parameters to reference from Terraform
  OIDCProviderArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /GitHubRunners/OIDCProviderArn
      Type: String
      Description: >-
        ARN of the IAM OIDC provider which trusts GitHub Actions
      Value: !Ref GitHubOIDCProvider
  KmsKeyArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /GitHubRunners/KmsKeyArn
      Type: String
      Description: >-
        KMS key for self-hosted runner secrets
      Value: !Ref KMSKey

Outputs:
  GitHubActionRoleArn:
    Description: ARN of the IAM role GitHub actions are allowed to assume
    Value: !GetAtt DelegationRole.Arn
  KMSKey:
    Description: KMS key for self-hosted runner secrets
    Value: !Ref KMSKey
